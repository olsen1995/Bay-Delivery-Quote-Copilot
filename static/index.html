<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bay Delivery – Quote Tool</title>
  <style>
    body { font-family: Arial; max-width: 760px; margin: 40px auto; padding: 0 14px; }
    label { display:block; margin-top:12px; font-weight: 600; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; box-sizing: border-box; }
    textarea { min-height: 110px; resize: vertical; }
    button { margin-top:18px; padding:12px; width:100%; font-weight: 700; cursor: pointer; }
    .result { margin-top:24px; padding:16px; border:1px solid #ccc; border-radius: 8px; }
    .muted { color:#666; font-size: 0.95em; margin-top: 10px; line-height: 1.35; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#f2f2f2; margin:6px 6px 0 0; font-size: 0.9em; }
    .error { color: #b00020; font-weight: 700; }
    .section { margin-top: 18px; padding-top: 6px; border-top: 1px dashed #ddd; }
    .hide { display: none; }
    .card { margin-top: 14px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
    .small { font-size: 0.92em; color: #555; }
  </style>
</head>
<body>

<h2>Bay Delivery – Quote Tool</h2>

<form id="quoteForm">

  <div class="row">
    <div>
      <label for="customer_name">Customer Name</label>
      <input type="text" id="customer_name" name="customer_name" placeholder="Required" required autocomplete="name" />
    </div>
    <div>
      <label for="customer_phone">Phone</label>
      <input type="text" id="customer_phone" name="customer_phone" placeholder="Required" required autocomplete="tel" />
    </div>
  </div>

  <label for="job_address">Job Address</label>
  <input type="text" id="job_address" name="job_address" placeholder="Required" required autocomplete="street-address" />

  <!-- PICKUP / DROP-OFF (MOVING + ITEM DELIVERY) -->
  <div class="section hide" id="route_section">
    <label for="pickup_address">Pickup Address</label>
    <input type="text" id="pickup_address" name="pickup_address" placeholder="Required for moving/delivery" />

    <label for="dropoff_address">Drop-off Address</label>
    <input type="text" id="dropoff_address" name="dropoff_address" placeholder="Required for moving/delivery" />

    <div class="muted">
      For <strong>Small Move</strong> and <strong>Item Delivery</strong>, we need both addresses to estimate properly.
    </div>
  </div>

  <label for="service_type">Service Type</label>
  <select id="service_type" name="service_type" title="Service Type">
    <option value="haul_away">Junk Removal / Haul Away</option>
    <option value="scrap_pickup">Scrap Pickup</option>
    <option value="small_move">Small Move</option>
    <option value="item_delivery">Item Delivery</option>
    <option value="demolition">Demolition</option>
  </select>

  <div class="muted" id="service_description"></div>

  <div class="row">
    <div>
      <label for="estimated_hours">Estimated Hours</label>
      <input type="number" id="estimated_hours" name="estimated_hours" value="1" min="0" step="0.25" />
      <div class="muted" id="hours_hint"></div>
    </div>
    <div>
      <label for="crew_size">Crew Size</label>
      <input type="number" id="crew_size" name="crew_size" value="1" min="1" step="1" />
      <div class="muted" id="crew_hint"></div>
    </div>
  </div>

  <!-- HAUL AWAY (JUNK/DUMP) -->
  <div class="section" id="haul_away_section">
    <label for="garbage_bag_count">Garbage Bags (optional)</label>
    <input type="number" id="garbage_bag_count" name="garbage_bag_count" value="0" min="0" step="1" />
    <div class="muted">
      Bags help us estimate the load size. Cash quotes are rounded to nearest $5.
    </div>

    <div class="row">
      <div>
        <label for="mattresses_count">Mattress Count</label>
        <input type="number" id="mattresses_count" name="mattresses_count" value="0" min="0" step="1" />
      </div>
      <div>
        <label for="box_springs_count">Box Spring Count</label>
        <input type="number" id="box_springs_count" name="box_springs_count" value="0" min="0" step="1" />
      </div>
    </div>

    <div class="muted">
      We load, haul, and dispose — <strong>removal &amp; disposal included</strong> (if required).
    </div>
  </div>

  <!-- SCRAP -->
  <div class="section hide" id="scrap_section">
    <label for="scrap_pickup_location">Scrap Pickup</label>
    <select id="scrap_pickup_location" name="scrap_pickup_location" title="Scrap Pickup Location">
      <option value="curbside">Curbside (Free)</option>
      <option value="inside">Inside (Flat $30)</option>
    </select>
    <div class="muted">
      Curbside scrap is free (picked up next time we’re in the area). If we have to go inside / carry it out, it’s a flat $30.
    </div>
  </div>

  <!-- MOVING -->
  <div class="section hide" id="moving_section">
    <div class="muted">
      Moving usually needs 3 workers. Minimum 2. We normally charge a minimum 4 hours for moving.
    </div>
  </div>

  <!-- DEMOLITION -->
  <div class="section hide" id="demo_section">
    <div class="muted">
      Demolition pricing depends on scope and debris. Final confirmed after review.
    </div>
  </div>

  <!-- COMMON -->
  <div class="section">
    <label for="description">Description (What are we moving/removing? Any heavy items?)</label>
    <textarea id="description" name="description" required minlength="8" placeholder="Example: 12 garbage bags, 1 couch, small dresser. Basement stairs. Tight hallway corner."></textarea>

    <div class="row">
      <div>
        <label for="stairs">Stairs?</label>
        <select id="stairs" name="stairs" title="Stairs">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
      <div>
        <label for="elevator">Elevator?</label>
        <select id="elevator" name="elevator" title="Elevator">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
    </div>

    <label for="difficult_corner">Difficult Corner / Tight Access?</label>
    <select id="difficult_corner" name="difficult_corner" title="Difficult Corner">
      <option value="false">No</option>
      <option value="true">Yes</option>
    </select>
  </div>

  <button type="submit">Generate Estimate</button>
</form>

<div id="result" class="result hide"></div>

<script>
  const fmt = (n) => (Number(n || 0)).toFixed(2);

  const serviceEl = document.getElementById("service_type");
  const serviceDescEl = document.getElementById("service_description");

  const haulAwaySection = document.getElementById("haul_away_section");
  const routeSection = document.getElementById("route_section");
  const pickupEl = document.getElementById("pickup_address");
  const dropoffEl = document.getElementById("dropoff_address");
  const scrapSection = document.getElementById("scrap_section");
  const movingSection = document.getElementById("moving_section");
  const demoSection = document.getElementById("demo_section");

  const crewEl = document.getElementById("crew_size");
  const crewHint = document.getElementById("crew_hint");
  const hoursHint = document.getElementById("hours_hint");
  const hoursEl = document.getElementById("estimated_hours");

  let lastQuoteId = null;

  function applyServiceDefaults() {
    const service = serviceEl.value;

    haulAwaySection.classList.toggle("hide", service !== "haul_away");
    scrapSection.classList.toggle("hide", service !== "scrap_pickup");
    movingSection.classList.toggle("hide", service !== "small_move");
    demoSection.classList.toggle("hide", service !== "demolition");

    const needsRoute = (service === "small_move" || service === "item_delivery");
    routeSection.classList.toggle("hide", !needsRoute);
    pickupEl.required = needsRoute;
    dropoffEl.required = needsRoute;

    let defaultCrew = 1;
    let minCrew = 1;
    let crewText = "";
    let hoursText = "";
    let serviceText = "";

    if (service === "small_move") {
      defaultCrew = 3;
      minCrew = 2;
      crewText = "Moving: default 3 workers (minimum 2).";
      hoursText = "Moving: pricing uses a minimum 4 hours.";
      serviceText = "Small Move estimate includes labour + travel. Pickup + drop-off required.";
    } else if (service === "demolition") {
      defaultCrew = 4;
      minCrew = 2;
      crewText = "Demolition: default 4 workers (minimum 2).";
      hoursText = "Demolition: enter your best estimate — final confirmed after review.";
      serviceText = "Demolition estimate includes labour + travel.";
    } else if (service === "haul_away") {
      defaultCrew = 1;
      minCrew = 1;
      crewText = "Junk removal / haul away: crew depends on items.";
      hoursText = "Enter a rough time estimate (loading + hauling).";
      serviceText = "We load, haul, and dispose — removal & disposal included (if required).";
    } else if (service === "item_delivery") {
      defaultCrew = 1;
      minCrew = 1;
      crewText = "Item delivery: crew depends on size/weight.";
      hoursText = "Enter a rough time estimate (loading + delivery).";
      serviceText = "Item Delivery estimate includes labour + travel. Pickup + drop-off required.";
    } else if (service === "scrap_pickup") {
      defaultCrew = 1;
      minCrew = 1;
      crewText = "Scrap pickup: curbside is free; inside removal is a flat $30.";
      hoursText = "Hours/crew don’t affect scrap pricing (flat-rate).";
      serviceText = "Scrap pickup is flat-rate: curbside free; inside removal $30.";
    }

    if (!crewEl.dataset.touched) {
      crewEl.value = String(defaultCrew);
    }
    const current = parseInt(crewEl.value || "1", 10);
    if (current < minCrew) crewEl.value = String(minCrew);

    crewHint.textContent = crewText;
    hoursHint.textContent = hoursText;
    serviceDescEl.textContent = serviceText;

    if (service === "scrap_pickup") {
      hoursEl.disabled = true;
      crewEl.disabled = true;
    } else {
      hoursEl.disabled = false;
      crewEl.disabled = false;
    }
  }

  crewEl.addEventListener("input", () => {
    crewEl.dataset.touched = "true";
    applyServiceDefaults();
  });

  serviceEl.addEventListener("change", () => {
    crewEl.dataset.touched = "";
    applyServiceDefaults();
  });

  applyServiceDefaults();

  function requiredTrim(id) {
    return (document.getElementById(id).value || "").trim();
  }

  function bookingPanelHTML(quoteId) {
    return `
      <div class="card">
        <h4 style="margin:0 0 6px 0;">Request Booking</h4>
        <div class="small">If you want to book this job, request a date/time window. We’ll review and confirm availability.</div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="requested_job_date">Preferred Date</label>
            <input type="date" id="requested_job_date" />
          </div>
          <div>
            <label for="requested_time_window">Preferred Time Window</label>
            <input type="text" id="requested_time_window" placeholder="Example: Morning / 1–3pm" />
          </div>
        </div>

        <label for="booking_notes">Notes (optional)</label>
        <input type="text" id="booking_notes" placeholder="Example: call when arriving, gate code, parking info" />

        <button type="button" id="requestBookingBtn">Request Booking</button>
        <div class="muted" id="bookingStatus"></div>
      </div>
    `;
  }

  async function submitBookingRequest() {
    const dateVal = (document.getElementById("requested_job_date").value || "").trim();
    const windowVal = (document.getElementById("requested_time_window").value || "").trim();
    const notesVal = (document.getElementById("booking_notes").value || "").trim();

    if (!lastQuoteId) {
      alert("No quote ID found. Please generate an estimate first.");
      return;
    }
    if (!dateVal || !windowVal) {
      alert("Please enter a preferred date and time window.");
      return;
    }

    const statusEl = document.getElementById("bookingStatus");
    statusEl.textContent = "Submitting booking request…";

    try {
      const res = await fetch("/quote/request-booking", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          quote_id: lastQuoteId,
          requested_job_date: dateVal,
          requested_time_window: windowVal,
          notes: notesVal || null
        })
      });

      const data = await res.json();
      if (!res.ok) {
        statusEl.innerHTML = `<span class="error">Error:</span> ${JSON.stringify(data)}`;
        return;
      }

      statusEl.textContent = `✅ Request sent. Request ID: ${data.request_id}. We will confirm availability.`;
    } catch (err) {
      statusEl.innerHTML = `<span class="error">Network error:</span> ${String(err)}`;
    }
  }

  document.getElementById("quoteForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const service = serviceEl.value;

    // Hard guardrail: prevent "no-info" quotes.
    const nameVal = requiredTrim("customer_name");
    const phoneVal = requiredTrim("customer_phone");
    const jobAddrVal = requiredTrim("job_address");
    const descVal = requiredTrim("description");

    if (!nameVal || !phoneVal || !jobAddrVal || descVal.length < 8) {
      alert("Please enter your name, phone number, job address, and a short description of the items (at least 8 characters).");
      return;
    }

    if (service === "small_move" || service === "item_delivery") {
      const pickupVal = requiredTrim("pickup_address");
      const dropVal = requiredTrim("dropoff_address");
      if (!pickupVal || !dropVal) {
        alert("For moving or item delivery, please enter both pickup and drop-off addresses.");
        return;
      }
    }

    const payload = {
      customer_name: nameVal,
      customer_phone: phoneVal,
      job_address: jobAddrVal,
      pickup_address: (requiredTrim("pickup_address") || null),
      dropoff_address: (requiredTrim("dropoff_address") || null),

      service_type: service,
      estimated_hours: parseFloat(document.getElementById("estimated_hours").value || "0"),
      crew_size: parseInt(document.getElementById("crew_size").value || "1", 10),

      garbage_bag_count: service === "haul_away"
        ? parseInt(document.getElementById("garbage_bag_count").value || "0", 10)
        : 0,

      mattresses_count: service === "haul_away"
        ? parseInt(document.getElementById("mattresses_count").value || "0", 10)
        : 0,

      box_springs_count: service === "haul_away"
        ? parseInt(document.getElementById("box_springs_count").value || "0", 10)
        : 0,

      scrap_pickup_location: service === "scrap_pickup"
        ? document.getElementById("scrap_pickup_location").value
        : "curbside",

      description: descVal,
      stairs: document.getElementById("stairs").value === "true",
      elevator: document.getElementById("elevator").value === "true",
      difficult_corner: document.getElementById("difficult_corner").value === "true",
    };

    const div = document.getElementById("result");
    div.classList.remove("hide");
    div.innerHTML = `<div class="muted">Calculating…</div>`;
    lastQuoteId = null;

    try {
      const res = await fetch("/quote/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) {
        div.innerHTML = `<div class="error">Error:</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
        return;
      }

      lastQuoteId = data.quote_id;

      const summary = [];
      if (service === "scrap_pickup") {
        summary.push("Flat-rate");
        summary.push(payload.scrap_pickup_location === "curbside" ? "Curbside free" : "Inside $30");
      } else {
        summary.push("Labour included");
        summary.push("Travel included");
        if (service === "haul_away") summary.push("Removal & disposal included");
      }

      div.innerHTML = `
        <h3>Estimate Generated</h3>
        <p><strong>Quote ID:</strong> ${data.quote_id}</p>
        <p><strong>Cash:</strong> $${fmt(data.total_cash_cad)}</p>
        <p><strong>EMT:</strong> $${fmt(data.total_emt_cad)}</p>

        <div style="margin-top: 10px;">
          ${summary.map(s => `<span class="pill">${s}</span>`).join("")}
        </div>

        <div class="muted">
          <strong>Important:</strong> ${data.disclaimer}
        </div>

        ${bookingPanelHTML(data.quote_id)}
      `;

      // Wire the booking button after render
      document.getElementById("requestBookingBtn").addEventListener("click", submitBookingRequest);

    } catch (err) {
      div.innerHTML = `<div class="error">Network error:</div><pre>${String(err)}</pre>`;
    }
  });
</script>

</body>
</html>