<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Bay Delivery – Quote Tool</title>
  <style>
    body { font-family: Arial; max-width: 760px; margin: 40px auto; }
    label { display:block; margin-top:12px; font-weight: 600; }
    input, select, textarea { width:100%; padding:10px; margin-top:6px; box-sizing: border-box; }
    textarea { min-height: 90px; resize: vertical; }
    button { margin-top:18px; padding:12px; width:100%; font-weight: 700; cursor: pointer; }
    .result { margin-top:24px; padding:16px; border:1px solid #ccc; border-radius: 8px; }
    .muted { color:#666; font-size: 0.95em; margin-top: 10px; line-height: 1.35; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#f2f2f2; margin:6px 6px 0 0; font-size: 0.9em; }
    .error { color: #b00020; font-weight: 700; }
    .section { margin-top: 18px; padding-top: 12px; border-top: 1px solid #eee; }
    .hint { font-size: 0.9em; color: #666; margin-top: 6px; }
  </style>
</head>
<body>

<h2>Bay Delivery – Quote Tool</h2>

<form id="quoteForm">

  <div class="row">
    <div>
      <label>Customer Name</label>
      <input type="text" id="customer_name" placeholder="Optional" />
    </div>
    <div>
      <label>Phone</label>
      <input type="text" id="customer_phone" placeholder="Optional" />
    </div>
  </div>

  <label>Job Address</label>
  <input type="text" id="job_address" placeholder="Optional (local pricing assumes North Bay unless noted)" />

  <label>Service Type</label>
  <select id="service_type">
    <option value="dump_run">Dump Run</option>
    <option value="scrap_pickup">Scrap Pickup</option>
    <option value="small_move">Small Move</option>
    <option value="item_delivery">Item Delivery</option>
    <option value="demolition">Demolition</option>
  </select>

  <div id="dumpRunSection" class="section">
    <h3 style="margin: 0 0 8px 0;">Dump Run Details</h3>
    <div class="row">
      <div>
        <label>Garbage Bags (count)</label>
        <input type="number" id="garbage_bags_count" value="0" min="0" step="1" />
        <div class="hint">Used only for Dump Runs. Pricing is handled automatically.</div>
      </div>
      <div>
        <label>Requires 2 Workers?</label>
        <select id="requires_two_workers">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
    </div>
  </div>

  <div class="row section">
    <div>
      <label>Estimated Hours</label>
      <input type="number" id="estimated_hours" value="1" min="0" step="0.25" />
    </div>
    <div>
      <label>Requires 2 Workers?</label>
      <select id="requires_two_workers_global">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>
      <div class="hint">If you set this to Yes, we assume 2-person labour.</div>
    </div>
  </div>

  <div class="row section">
    <div>
      <label>Mattress Count</label>
      <input type="number" id="mattresses_count" value="0" min="0" step="1" />
    </div>
    <div>
      <label>Box Spring Count</label>
      <input type="number" id="box_springs_count" value="0" min="0" step="1" />
    </div>
  </div>

  <div class="section">
    <h3 style="margin: 0 0 8px 0;">Access & Difficulty</h3>

    <div class="row">
      <div>
        <label>Stairs involved?</label>
        <select id="has_stairs">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
      <div>
        <label>Tight corners / difficult access?</label>
        <select id="has_tight_corners">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Long carry distance (far walk to truck)?</label>
        <select id="has_long_carry">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
      <div>
        <label>Apartment / Condo?</label>
        <select id="is_apartment_condo">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Elevator available?</label>
        <select id="has_elevator">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
        <div class="hint">If Apartment/Condo + Elevator = helps reduce access difficulty.</div>
      </div>
      <div></div>
    </div>
  </div>

  <div class="section">
    <label>Description of items / job</label>
    <textarea id="job_description_customer" placeholder="Example: 1 couch, 1 dresser, 10 garbage bags, basement stairs, tight hallway..."></textarea>
    <div class="hint">This is logged with the quote so you can review it on your end.</div>
  </div>

  <button type="submit">Generate Estimate</button>
</form>

<div id="result" class="result" style="display:none;"></div>

<script>
  const fmt = (n) => {
    const x = Number(n || 0);
    return x.toFixed(2);
  };

  const serviceTypeEl = document.getElementById("service_type");
  const dumpRunSection = document.getElementById("dumpRunSection");

  function syncServiceUI() {
    const st = serviceTypeEl.value;
    dumpRunSection.style.display = (st === "dump_run") ? "block" : "none";
  }
  serviceTypeEl.addEventListener("change", syncServiceUI);
  syncServiceUI();

  document.getElementById("quoteForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const serviceType = document.getElementById("service_type").value;

    // If dump_run, use the dump-run "requires_two_workers" selector; otherwise use global.
    const req2Workers = (serviceType === "dump_run")
      ? (document.getElementById("requires_two_workers").value === "true")
      : (document.getElementById("requires_two_workers_global").value === "true");

    const payload = {
      customer_name: document.getElementById("customer_name").value || null,
      customer_phone: document.getElementById("customer_phone").value || null,
      job_address: document.getElementById("job_address").value || null,
      service_type: serviceType,

      estimated_hours: parseFloat(document.getElementById("estimated_hours").value || "0"),
      requires_two_workers: req2Workers,

      mattresses_count: parseInt(document.getElementById("mattresses_count").value || "0", 10),
      box_springs_count: parseInt(document.getElementById("box_springs_count").value || "0", 10),

      // dump_run bags (used only when service_type=dump_run)
      garbage_bags_count: parseInt(document.getElementById("garbage_bags_count").value || "0", 10),

      // access/difficulty
      has_stairs: document.getElementById("has_stairs").value === "true",
      has_tight_corners: document.getElementById("has_tight_corners").value === "true",
      has_long_carry: document.getElementById("has_long_carry").value === "true",
      is_apartment_condo: document.getElementById("is_apartment_condo").value === "true",
      has_elevator: document.getElementById("has_elevator").value === "true",

      // description
      job_description_customer: document.getElementById("job_description_customer").value || null
    };

    const div = document.getElementById("result");
    div.style.display = "block";
    div.innerHTML = `<div class="muted">Calculating…</div>`;

    try {
      const res = await fetch("/quote/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!res.ok) {
        div.innerHTML = `<div class="error">Error:</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
        return;
      }

      // Summary pills (no $ amounts for labour/access/etc — only disposal amounts when entered)
      const summary = [];
      summary.push("Labour included");
      summary.push("Local base pricing (North Bay)");

      if (payload.has_stairs) summary.push("Stairs");
      if (payload.has_tight_corners) summary.push("Tight corners");
      if (payload.has_long_carry) summary.push("Long carry");
      if (payload.is_apartment_condo) summary.push("Apartment/condo");
      if (payload.is_apartment_condo && payload.has_elevator) summary.push("Elevator");

      if (payload.service_type === "dump_run" && payload.garbage_bags_count > 0) {
        summary.push(`${payload.garbage_bags_count} garbage bags`);
      }

      // Only show mattress/boxspring amounts if counts > 0
      const m = payload.mattresses_count || 0;
      const b = payload.box_springs_count || 0;

      let disposalHtml = "";
      if (m > 0 || b > 0) {
        const mattressCost = m * 50;
        const boxCost = b * 50;
        disposalHtml = `
          <div style="margin-top: 10px;">
            <div><strong>Disposal (shown only because you entered items):</strong></div>
            ${m > 0 ? `<div class="pill">Mattress: ${m} × $50 = $${fmt(mattressCost)}</div>` : ""}
            ${b > 0 ? `<div class="pill">Box Spring: ${b} × $50 = $${fmt(boxCost)}</div>` : ""}
          </div>
        `;
      }

      div.innerHTML = `
        <h3>Estimate Generated</h3>
        <p><strong>Quote ID:</strong> ${data.quote_id}</p>
        <p><strong>Cash:</strong> $${fmt(data.total_cash_cad)}</p>
        <p><strong>EMT:</strong> $${fmt(data.total_emt_cad)}</p>

        <div style="margin-top: 10px;">
          ${summary.map(s => `<span class="pill">${s}</span>`).join("")}
        </div>

        ${disposalHtml}

        <div class="muted">
          <strong>Important:</strong> This estimate is solely based on the information provided.
          Quote may be subject to change after an in-person view (stairs, heavy items, access, actual dump/landfill fees, multiple trips, etc.).
        </div>
      `;
    } catch (err) {
      div.innerHTML = `<div class="error">Network error:</div><pre>${String(err)}</pre>`;
    }
  });
</script>

</body>
</html>