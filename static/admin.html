<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bay Delivery – Admin</title>
  <link rel="stylesheet" href="/static/admin.css" />
</head>
<body>

<h2>Bay Delivery – Admin Dashboard</h2>
<div class="muted">
  View recent estimates, booking requests, and jobs. Approvals create a job record automatically.
</div>

<div class="card mt14">
  <div class="small">
    Admin access uses your Render environment variables: <code>ADMIN_USERNAME</code> + <code>ADMIN_PASSWORD</code>.
    Open with <code>?token=...</code> once; it is saved to session storage and removed from the URL. API calls use <code>X-Admin-Token</code>.
  </div>

  <div class="rowCreds">
    <input id="adminUsername" type="text" placeholder="Admin username" />
    <input id="adminPassword" type="password" placeholder="Admin password" />
  </div>

  <div class="rowToken mt10">
    <div></div>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div class="muted" id="statusLine"></div>
</div>

<div class="card mt14">
  <h3>Drive Vault</h3>
  <div class="muted">
    Check Drive setup, trigger a DB snapshot, and list recent Drive backups for demo/recovery.
  </div>

  <div class="btnRow mt10">
    <button id="driveStatusBtn">Check Drive Status</button>
    <button id="driveSnapshotBtn" class="btnSpacer">Snapshot DB to Drive</button>
    <button id="driveBackupsBtn" class="btnSpacer">List Drive Backups</button>
  </div>

  <div class="muted small mt10" id="driveStatusLine"></div>
  <div id="driveBackupsBox"></div>
</div>

<div class="card mt14">
  <h3>DB Backup (Render Free Tier)</h3>
  <div class="muted">
    Render free tier has no persistent disk. Use <strong>Export</strong> to download a JSON backup and keep it safe.
    Use <strong>Import</strong> to restore the database after a redeploy/reset.
  </div>
  <div class="muted small mt10">
    Note: Google Drive snapshot/list/restore endpoints require Drive env vars to be configured on the server.
  </div>

  <div class="rowBackup mt10">
    <button id="exportDbBtn">Export DB to JSON</button>

    <div class="importBox">
      <label for="importFile">Import backup file</label>
      <input id="importFile" type="file" accept="application/json" />
      <button id="importDbBtn" class="btnSpacer">Import JSON Backup</button>
    </div>
  </div>

  <div class="muted small mt10" id="backupStatus"></div>
</div>

<div class="row">
  <div class="card">
    <h3>Recent Estimates</h3>
    <div class="muted">Latest stored quotes (for ops review).</div>
    <div id="quotesBox"></div>
  </div>

  <div class="card">
    <h3>Booking Requests</h3>
    <div class="muted">Approve → creates a job entry. Reject → closes the request.</div>
    <div id="requestsBox"></div>
  </div>
</div>

<div class="card mt14">
  <h3>Jobs</h3>
  <div class="muted">Jobs created after admin approval (baseline total uses cash quote; payment method set later).</div>
  <div id="jobsBox"></div>
</div>

<script>
  const statusLine = document.getElementById("statusLine");
  const backupStatus = document.getElementById("backupStatus");
  const driveStatusLine = document.getElementById("driveStatusLine");
  const driveBackupsBox = document.getElementById("driveBackupsBox");

  function bootstrapTokenFromUrl() {
    const url = new URL(window.location.href);
    const token = (url.searchParams.get("token") || "").trim();
    if (!token) return;
    sessionStorage.setItem("bay_admin_token", token);
    url.searchParams.delete("token");
    window.history.replaceState({}, "", url.toString());
  }

  function authHeaders() {
    const headers = {};

    const token = (sessionStorage.getItem("bay_admin_token") || "").trim();
    if (token) {
      headers["X-Admin-Token"] = token;
    }

    const u = (document.getElementById("adminUsername").value || "").trim();
    const p = (document.getElementById("adminPassword").value || "").trim();
    if (u && p) {
      headers["Authorization"] = "Basic " + btoa(u + ":" + p);
    }
    return headers;
  }

  function setLine(el, level, msg, suffixCode) {
    el.textContent = "";
    const span = document.createElement("span");
    if (level === "ok") span.className = "ok";
    if (level === "bad") span.className = "bad";
    span.textContent = msg;
    el.appendChild(span);

    if (suffixCode) {
      el.appendChild(document.createTextNode(" "));
      const code = document.createElement("code");
      code.textContent = suffixCode;
      el.appendChild(code);
    }
  }

  function clearNode(node) {
    while (node.firstChild) node.removeChild(node.firstChild);
  }

  function createTable(headers) {
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tr = document.createElement("tr");
    headers.forEach((h) => {
      const th = document.createElement("th");
      th.textContent = h;
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    table.appendChild(thead);
    const tbody = document.createElement("tbody");
    table.appendChild(tbody);
    return { table, tbody };
  }

  function addEmptyState(container, text) {
    clearNode(container);
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = text;
    container.appendChild(div);
  }

  async function fetchJSON(path) {
    const res = await fetch(path, { headers: authHeaders() });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(JSON.stringify(data));
    return data;
  }

  function statusLabel(status) {
    const map = {
      customer_accepted_pending_admin: "Customer accepted (pending admin)",
      customer_declined: "Customer declined",
      admin_approved: "Admin approved",
      rejected: "Rejected"
    };
    return map[status] || (status || "unknown");
  }

  function renderQuotes(items) {
    const box = document.getElementById("quotesBox");
    if (!items || items.length === 0) return addEmptyState(box, "No quotes yet.");
    clearNode(box);

    const { table, tbody } = createTable(["Quote ID", "Created", "Type", "Total (cash)"]);

    items.forEach((q) => {
      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      const code = document.createElement("code");
      code.textContent = q.quote_id || "";
      tdId.appendChild(code);

      const tdCreated = document.createElement("td");
      tdCreated.textContent = q.created_at || "";

      const tdType = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = q.job_type || "";
      tdType.appendChild(pill);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = "$" + Number(q.total_cad || 0).toFixed(2);

      tr.append(tdId, tdCreated, tdType, tdTotal);
      tbody.appendChild(tr);
    });

    box.appendChild(table);
  }

  async function decide(requestId, action) {
    const notes = prompt("Admin notes (" + action + ") - optional:") || "";
    statusLine.textContent = "Saving decision...";

    const headers = Object.assign({ "Content-Type": "application/json" }, authHeaders());
    const res = await fetch("/admin/api/quote-requests/" + encodeURIComponent(requestId) + "/decision", {
      method: "POST",
      headers,
      body: JSON.stringify({ action, notes: (notes.trim() || null) })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setLine(statusLine, "bad", "Error:");
      statusLine.appendChild(document.createTextNode(" " + JSON.stringify(data)));
      return;
    }

    const jobId = data && data.job && data.job.job_id;
    if (jobId) {
      setLine(statusLine, "ok", "Approved. Job created:", jobId);
    } else {
      setLine(statusLine, "ok", "Saved: " + action.toUpperCase() + " for");
      statusLine.appendChild(document.createTextNode(" " + requestId));
    }

    await refreshAll();
  }

  function actionCell(item) {
    const td = document.createElement("td");
    const st = (item.status || "").toLowerCase();

    if (st === "customer_declined" || st === "rejected") {
      const noAction = document.createElement("span");
      noAction.className = "muted small";
      noAction.textContent = "No action needed";
      td.appendChild(noAction);
      return td;
    }

    const approveBtn = document.createElement("button");
    approveBtn.type = "button";
    approveBtn.textContent = "Approve";
    approveBtn.addEventListener("click", () => decide(item.request_id || "", "approve"));

    const rejectBtn = document.createElement("button");
    rejectBtn.type = "button";
    rejectBtn.className = "btnSpacer";
    rejectBtn.textContent = "Reject";
    rejectBtn.addEventListener("click", () => decide(item.request_id || "", "reject"));

    td.append(approveBtn, rejectBtn);
    return td;
  }

  function renderRequests(items) {
    const box = document.getElementById("requestsBox");
    if (!items || items.length === 0) return addEmptyState(box, "No booking requests yet.");
    clearNode(box);

    const { table, tbody } = createTable(["Request", "Customer", "Job", "Requested", "Totals", "Actions"]);

    items.forEach((r) => {
      const tr = document.createElement("tr");

      const tdReq = document.createElement("td");
      const reqCode = document.createElement("code");
      reqCode.textContent = r.request_id || "";
      const reqDate = document.createElement("div");
      reqDate.className = "small";
      reqDate.textContent = r.created_at || "";
      tdReq.append(reqCode, reqDate);

      const tdCustomer = document.createElement("td");
      const cName = document.createElement("div");
      cName.textContent = r.customer_name || "";
      const cPhone = document.createElement("div");
      cPhone.className = "small";
      cPhone.textContent = r.customer_phone || "";
      tdCustomer.append(cName, cPhone);

      const tdJob = document.createElement("td");
      tdJob.className = "small";
      const addr = document.createElement("div");
      addr.textContent = r.job_address || "";
      const svc = document.createElement("div");
      svc.textContent = "Service: " + (r.service_type || "");
      tdJob.append(addr, svc);

      const tdRequested = document.createElement("td");
      tdRequested.className = "small";
      const date = document.createElement("div");
      date.textContent = "Date: " + (r.requested_job_date || "-");
      const windowEl = document.createElement("div");
      windowEl.textContent = "Window: " + (r.requested_time_window || "-");
      tdRequested.append(date, windowEl);

      const tdTotals = document.createElement("td");
      const stWrap = document.createElement("div");
      stWrap.className = "small";
      const stPill = document.createElement("span");
      stPill.className = "pill";
      stPill.textContent = statusLabel(r.status);
      stWrap.appendChild(document.createTextNode("Status: "));
      stWrap.appendChild(stPill);

      const cash = document.createElement("div");
      cash.className = "small";
      cash.textContent = "Cash: $" + Number(r.cash_total_cad || 0).toFixed(2);

      const emt = document.createElement("div");
      emt.className = "small";
      emt.textContent = "EMT: $" + Number(r.emt_total_cad || 0).toFixed(2);

      tdTotals.append(stWrap, cash, emt);

      tr.append(tdReq, tdCustomer, tdJob, tdRequested, tdTotals, actionCell(r));
      tbody.appendChild(tr);
    });

    box.appendChild(table);
  }

  function renderJobs(items) {
    const box = document.getElementById("jobsBox");
    if (!items || items.length === 0) return addEmptyState(box, "No jobs yet.");
    clearNode(box);

    const { table, tbody } = createTable(["Job", "Quote", "Status", "Customer", "Address", "Total", "Notes"]);

    items.forEach((j) => {
      const tr = document.createElement("tr");

      const tdJob = document.createElement("td");
      const jobCode = document.createElement("code");
      jobCode.textContent = j.job_id || "";
      const created = document.createElement("div");
      created.className = "small";
      created.textContent = j.created_at || "";
      tdJob.append(jobCode, created);

      const tdQuote = document.createElement("td");
      const qCode = document.createElement("code");
      qCode.textContent = j.quote_id || "";
      tdQuote.appendChild(qCode);

      const tdStatus = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = j.status || "";
      tdStatus.appendChild(pill);

      const tdCustomer = document.createElement("td");
      const name = document.createElement("div");
      const strong = document.createElement("strong");
      strong.textContent = j.customer_name || "";
      name.appendChild(strong);
      const phone = document.createElement("div");
      phone.className = "small";
      phone.textContent = j.customer_phone || "";
      tdCustomer.append(name, phone);

      const tdAddress = document.createElement("td");
      tdAddress.className = "small";
      tdAddress.textContent = j.job_address || "";

      const tdTotal = document.createElement("td");
      tdTotal.textContent = "$" + Number(j.total_cad || 0).toFixed(2);

      const tdNotes = document.createElement("td");
      tdNotes.className = "small";
      tdNotes.textContent = j.notes || "";

      tr.append(tdJob, tdQuote, tdStatus, tdCustomer, tdAddress, tdTotal, tdNotes);
      tbody.appendChild(tr);
    });

    box.appendChild(table);
  }

  function renderDriveBackups(items) {
    if (!items || items.length === 0) return addEmptyState(driveBackupsBox, "No Drive backups found.");
    clearNode(driveBackupsBox);

    const { table, tbody } = createTable(["Name", "Created", "Size (bytes)", "Link"]);

    items.forEach((f) => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const code = document.createElement("code");
      code.textContent = f.name || "";
      tdName.appendChild(code);

      const tdCreated = document.createElement("td");
      tdCreated.textContent = f.created_time || "";

      const tdSize = document.createElement("td");
      tdSize.textContent = String(f.size || "-");

      const tdLink = document.createElement("td");
      if (f.web_view_link) {
        const a = document.createElement("a");
        a.href = f.web_view_link;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = "Open";
        tdLink.appendChild(a);
      } else {
        tdLink.textContent = "-";
      }

      tr.append(tdName, tdCreated, tdSize, tdLink);
      tbody.appendChild(tr);
    });

    driveBackupsBox.appendChild(table);
  }

  async function refreshAll() {
    try {
      statusLine.textContent = "Loading...";
      renderQuotes((await fetchJSON("/admin/api/quotes")).items || []);
      renderRequests((await fetchJSON("/admin/api/quote-requests")).items || []);
      renderJobs((await fetchJSON("/admin/api/jobs")).items || []);
      setLine(statusLine, "ok", "Loaded.");
    } catch (err) {
      setLine(statusLine, "bad", "Admin API error:");
      statusLine.appendChild(document.createTextNode(" " + String(err)));
    }
  }

  async function checkDriveStatus() {
    try {
      driveStatusLine.textContent = "Checking Drive...";
      const configured = Boolean((await fetchJSON("/health")).drive_configured);
      setLine(driveStatusLine, configured ? "ok" : "bad", configured ? "Drive configured." : "Drive not configured.");
    } catch (err) {
      setLine(driveStatusLine, "bad", "Drive status check failed:");
      driveStatusLine.appendChild(document.createTextNode(" " + String(err)));
    }
  }

  async function snapshotDrive() {
    try {
      driveStatusLine.textContent = "Creating Drive snapshot...";
      const res = await fetch("/admin/api/drive/snapshot", { method: "POST", headers: authHeaders() });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(JSON.stringify(data));
      setLine(driveStatusLine, "ok", "Snapshot complete:", data.name || data.file_id || "backup");
      await listDriveBackups();
    } catch (err) {
      setLine(driveStatusLine, "bad", "Snapshot failed:");
      driveStatusLine.appendChild(document.createTextNode(" " + String(err)));
    }
  }

  async function listDriveBackups() {
    try {
      driveStatusLine.textContent = "Loading Drive backups...";
      renderDriveBackups((await fetchJSON("/admin/api/drive/backups?limit=20")).items || []);
      setLine(driveStatusLine, "ok", "Loaded Drive backups.");
    } catch (err) {
      clearNode(driveBackupsBox);
      setLine(driveStatusLine, "bad", "Could not list Drive backups:");
      driveStatusLine.appendChild(document.createTextNode(" " + String(err)));
    }
  }

  async function exportDb() {
    try {
      backupStatus.textContent = "Exporting...";
      const res = await fetch("/admin/api/db/export", { headers: authHeaders() });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(JSON.stringify(data));
      }

      const blob = await res.blob();
      const dispo = res.headers.get("Content-Disposition") || "";
      let filename = "bay_delivery_backup.json";
      const m = dispo.match(/filename="([^"]+)"/i);
      if (m && m[1]) filename = m[1];

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setLine(backupStatus, "ok", "Exported. Saved as", filename);
    } catch (err) {
      setLine(backupStatus, "bad", "Export failed:");
      backupStatus.appendChild(document.createTextNode(" " + String(err)));
    }
  }

  async function importDb() {
    try {
      const file = document.getElementById("importFile").files[0];
      if (!file) {
        setLine(backupStatus, "bad", "Choose a JSON file first.");
        return;
      }

      if (!confirm("This will WIPE the current DB and restore from the JSON backup. Continue?")) {
        return;
      }

      backupStatus.textContent = "Importing...";
      const payload = JSON.parse(await file.text());

      const headers = Object.assign({ "Content-Type": "application/json" }, authHeaders());
      const res = await fetch("/admin/api/db/import", {
        method: "POST",
        headers,
        body: JSON.stringify({ payload })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(JSON.stringify(data));

      const restored = data.restored || {};
      setLine(backupStatus, "ok", "Imported.");
      backupStatus.appendChild(document.createTextNode(
        " quotes=" + (restored.quotes || 0)
        + ", quote_requests=" + (restored.quote_requests || 0)
        + ", jobs=" + (restored.jobs || 0)
      ));

      await refreshAll();
    } catch (err) {
      setLine(backupStatus, "bad", "Import failed:");
      backupStatus.appendChild(document.createTextNode(" " + String(err)));
    }
  }

  document.getElementById("driveStatusBtn").addEventListener("click", checkDriveStatus);
  document.getElementById("driveSnapshotBtn").addEventListener("click", snapshotDrive);
  document.getElementById("driveBackupsBtn").addEventListener("click", listDriveBackups);
  document.getElementById("exportDbBtn").addEventListener("click", exportDb);
  document.getElementById("importDbBtn").addEventListener("click", importDb);
  document.getElementById("refreshBtn").addEventListener("click", refreshAll);

  bootstrapTokenFromUrl();
  refreshAll();
</script>

</body>
</html>
