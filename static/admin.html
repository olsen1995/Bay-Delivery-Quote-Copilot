<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bay Delivery – Admin</title>
  <link rel="stylesheet" href="/static/admin.css" />
</head>
<body>

<h2>Bay Delivery – Admin Dashboard</h2>
<div class="muted">
  View recent estimates, booking requests, and jobs. Approvals create a job record automatically.
</div>

<div class="card mt14">
  <div class="small">
    Admin access uses <strong>Basic Auth</strong> with your Render environment variables:
    <code>ADMIN_USERNAME</code> + <code>ADMIN_PASSWORD</code>.
    <div class="muted small mt10">
      Note: token-based auth (<code>?token=</code> / <code>X-Admin-Token</code>) is not used by the backend.
    </div>
  </div>

  <div class="rowCreds mt10">
    <input id="adminUsername" type="text" placeholder="Admin username" autocomplete="username" />
    <input id="adminPassword" type="password" placeholder="Admin password" autocomplete="current-password" />
  </div>

  <div class="rowToken mt10">
    <div></div>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div class="muted" id="statusLine"></div>
</div>

<div class="row">
  <div class="card">
    <h3>Recent Estimates</h3>
    <div class="muted">Latest stored quotes (for ops review).</div>
    <div id="quotesBox"></div>
  </div>

  <div class="card">
    <h3>Booking Requests</h3>
    <div class="muted">Approve → creates a job entry. Reject → closes the request.</div>
    <div id="requestsBox"></div>
  </div>
</div>

<div class="card mt14">
  <h3>Jobs</h3>
  <div class="muted">Jobs created after admin approval.</div>
  <div id="jobsBox"></div>
</div>

<script>
  const statusLine = document.getElementById("statusLine");

  function authHeaders() {
    const headers = {};
    const u = (document.getElementById("adminUsername").value || "").trim();
    const p = (document.getElementById("adminPassword").value || "").trim();
    if (u && p) {
      headers["Authorization"] = "Basic " + btoa(u + ":" + p);
    }
    return headers;
  }

  function setLine(el, level, msg, suffixCode) {
    el.textContent = "";
    const span = document.createElement("span");
    if (level === "ok") span.className = "ok";
    if (level === "bad") span.className = "bad";
    span.textContent = msg;
    el.appendChild(span);

    if (suffixCode) {
      el.appendChild(document.createTextNode(" "));
      const code = document.createElement("code");
      code.textContent = suffixCode;
      el.appendChild(code);
    }
  }

  function clearNode(node) {
    while (node.firstChild) node.removeChild(node.firstChild);
  }

  function createTable(headers) {
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tr = document.createElement("tr");
    headers.forEach((h) => {
      const th = document.createElement("th");
      th.textContent = h;
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    table.appendChild(thead);
    const tbody = document.createElement("tbody");
    table.appendChild(tbody);
    return { table, tbody };
  }

  function addEmptyState(container, text) {
    clearNode(container);
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = text;
    container.appendChild(div);
  }

  async function fetchJSON(path) {
    const res = await fetch(path, { headers: authHeaders() });

    // Some auth failures come back non-JSON; handle safely.
    const text = await res.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

    if (!res.ok) {
      // keep the backend message intact
      throw new Error(JSON.stringify(data));
    }
    return data;
  }

  function safeGet(obj, path, fallback = "") {
    try {
      return path.split(".").reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), obj) ?? fallback;
    } catch {
      return fallback;
    }
  }

  function statusLabel(status) {
    const map = {
      customer_pending: "Customer pending",
      customer_accepted: "Customer accepted",
      customer_declined: "Customer declined",
      admin_approved: "Admin approved",
      rejected: "Rejected"
    };
    return map[(status || "").toLowerCase()] || (status || "unknown");
  }

  function money(n) {
    const x = Number(n || 0);
    return "$" + x.toFixed(2);
  }

  function renderQuotes(items) {
    const box = document.getElementById("quotesBox");
    if (!items || items.length === 0) return addEmptyState(box, "No quotes yet.");
    clearNode(box);

    const { table, tbody } = createTable(["Quote ID", "Created", "Service", "Cash Total"]);

    items.forEach((q) => {
      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      const code = document.createElement("code");
      code.textContent = q.quote_id || "";
      tdId.appendChild(code);

      const tdCreated = document.createElement("td");
      tdCreated.textContent = q.created_at || "";

      const tdSvc = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = safeGet(q, "request.service_type", "");
      tdSvc.appendChild(pill);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = money(safeGet(q, "response.cash_total_cad", 0));

      tr.append(tdId, tdCreated, tdSvc, tdTotal);
      tbody.appendChild(tr);
    });

    box.appendChild(table);
  }

  async function decide(requestId, action) {
    const notes = prompt("Admin notes (" + action + ") - optional:") || "";
    statusLine.textContent = "Saving decision...";

    const headers = Object.assign({ "Content-Type": "application/json" }, authHeaders());
    const res = await fetch("/admin/api/quote-requests/" + encodeURIComponent(requestId) + "/decision", {
      method: "POST",
      headers,
      body: JSON.stringify({ action, notes: (notes.trim() || null) })
    });

    const text = await res.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

    if (!res.ok) {
      setLine(statusLine, "bad", "Error:");
      statusLine.appendChild(document.createTextNode(" " + JSON.stringify(data)));
      return;
    }

    const newStatus = safeGet(data, "request.status", "");
    setLine(statusLine, "ok", "Saved:", (newStatus || action.toUpperCase()));

    await refreshAll();
  }

  function actionCell(item) {
    const td = document.createElement("td");
    const st = (item.status || "").toLowerCase();

    // Only allow admin action once customer accepted
    if (st !== "customer_accepted") {
      const noAction = document.createElement("span");
      noAction.className = "muted small";
      if (st === "customer_pending") noAction.textContent = "Waiting on customer";
      else noAction.textContent = "No action needed";
      td.appendChild(noAction);
      return td;
    }

    const approveBtn = document.createElement("button");
    approveBtn.type = "button";
    approveBtn.textContent = "Approve";
    approveBtn.addEventListener("click", () => decide(item.request_id || "", "approve"));

    const rejectBtn = document.createElement("button");
    rejectBtn.type = "button";
    rejectBtn.className = "btnSpacer";
    rejectBtn.textContent = "Reject";
    rejectBtn.addEventListener("click", () => decide(item.request_id || "", "reject"));

    td.append(approveBtn, rejectBtn);
    return td;
  }

  function renderRequests(items) {
    const box = document.getElementById("requestsBox");
    if (!items || items.length === 0) return addEmptyState(box, "No booking requests yet.");
    clearNode(box);

    const { table, tbody } = createTable(["Request", "Customer", "Job", "Requested", "Totals", "Actions"]);

    items.forEach((r) => {
      const tr = document.createElement("tr");

      const tdReq = document.createElement("td");
      const reqCode = document.createElement("code");
      reqCode.textContent = r.request_id || "";
      const reqDate = document.createElement("div");
      reqDate.className = "small";
      reqDate.textContent = r.created_at || "";
      tdReq.append(reqCode, reqDate);

      const tdCustomer = document.createElement("td");
      const cName = document.createElement("div");
      cName.textContent = r.customer_name || "";
      const cPhone = document.createElement("div");
      cPhone.className = "small";
      cPhone.textContent = r.customer_phone || "";
      tdCustomer.append(cName, cPhone);

      const tdJob = document.createElement("td");
      tdJob.className = "small";
      const addr = document.createElement("div");
      addr.textContent = r.job_address || "";
      const svc = document.createElement("div");
      svc.textContent = "Service: " + (r.service_type || "");
      tdJob.append(addr, svc);

      const tdRequested = document.createElement("td");
      tdRequested.className = "small";
      const date = document.createElement("div");
      date.textContent = "Date: " + (r.requested_job_date || "-");
      const windowEl = document.createElement("div");
      windowEl.textContent = "Window: " + (r.requested_time_window || "-");
      tdRequested.append(date, windowEl);

      const tdTotals = document.createElement("td");
      const stWrap = document.createElement("div");
      stWrap.className = "small";
      const stPill = document.createElement("span");
      stPill.className = "pill";
      stPill.textContent = statusLabel(r.status);
      stWrap.appendChild(document.createTextNode("Status: "));
      stWrap.appendChild(stPill);

      const cash = document.createElement("div");
      cash.className = "small";
      cash.textContent = "Cash: " + money(r.cash_total_cad);

      const emt = document.createElement("div");
      emt.className = "small";
      emt.textContent = "EMT: " + money(r.emt_total_cad);

      tdTotals.append(stWrap, cash, emt);

      tr.append(tdReq, tdCustomer, tdJob, tdRequested, tdTotals, actionCell(r));
      tbody.appendChild(tr);
    });

    box.appendChild(table);
  }

  function renderJobs(items) {
    const box = document.getElementById("jobsBox");
    if (!items || items.length === 0) return addEmptyState(box, "No jobs yet.");
    clearNode(box);

    const { table, tbody } = createTable(["Job", "Quote", "Status", "Customer", "Address", "Cash Total", "Notes"]);

    items.forEach((j) => {
      const tr = document.createElement("tr");

      const tdJob = document.createElement("td");
      const jobCode = document.createElement("code");
      jobCode.textContent = j.job_id || "";
      const created = document.createElement("div");
      created.className = "small";
      created.textContent = j.created_at || "";
      tdJob.append(jobCode, created);

      const tdQuote = document.createElement("td");
      const qCode = document.createElement("code");
      qCode.textContent = j.quote_id || "";
      tdQuote.appendChild(qCode);

      const tdStatus = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = j.status || "";
      tdStatus.appendChild(pill);

      const tdCustomer = document.createElement("td");
      const name = document.createElement("div");
      const strong = document.createElement("strong");
      strong.textContent = j.customer_name || "";
      name.appendChild(strong);
      const phone = document.createElement("div");
      phone.className = "small";
      phone.textContent = j.customer_phone || "";
      tdCustomer.append(name, phone);

      const tdAddress = document.createElement("td");
      tdAddress.className = "small";
      tdAddress.textContent = j.job_address || "";

      const tdTotal = document.createElement("td");
      tdTotal.textContent = money(j.cash_total_cad);

      const tdNotes = document.createElement("td");
      tdNotes.className = "small";
      tdNotes.textContent = j.notes || "";

      tr.append(tdJob, tdQuote, tdStatus, tdCustomer, tdAddress, tdTotal, tdNotes);
      tbody.appendChild(tr);
    });

    box.appendChild(table);
  }

  async function refreshAll() {
    try {
      statusLine.textContent = "Loading...";

      const quotes = await fetchJSON("/admin/api/quotes");
      renderQuotes((quotes.items || []));

      const reqs = await fetchJSON("/admin/api/quote-requests");
      renderRequests((reqs.items || []));

      const jobs = await fetchJSON("/admin/api/jobs");
      renderJobs((jobs.items || []));

      setLine(statusLine, "ok", "Loaded.");
    } catch (err) {
      setLine(statusLine, "bad", "Admin API error:");
      statusLine.appendChild(document.createTextNode(" " + String(err)));
    }
  }

  document.getElementById("refreshBtn").addEventListener("click", refreshAll);

  // On first load, we *don't* auto-refresh with empty creds — it will just 401 and look “broken”.
  setLine(statusLine, "bad", "Enter admin username/password, then click Refresh.");
</script>

</body>
</html>