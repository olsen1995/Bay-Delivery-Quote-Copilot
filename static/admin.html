<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bay Delivery – Admin</title>
  <link rel="stylesheet" href="/static/admin.css" />
</head>
<body>

<h2>Bay Delivery – Admin Dashboard</h2>
<div class="muted">
  View recent estimates, booking requests, and jobs. Approvals create a job record automatically.
</div>

<div class="card mt14">
  <div class="small">
    Admin access uses your Render environment variables: <code>ADMIN_USERNAME</code> + <code>ADMIN_PASSWORD</code>.
  </div>

  <div class="rowCreds">
    <input id="adminUsername" type="text" placeholder="Admin username" />
    <input id="adminPassword" type="password" placeholder="Admin password" />
  </div>

  <div class="rowToken mt10">
    <div></div>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div class="muted" id="statusLine"></div>
</div>

<div class="card mt14">
  <h3>Drive Vault</h3>
  <div class="muted">
    Check Drive setup, trigger a DB snapshot, and list recent Drive backups for demo/recovery.
  </div>

  <div class="btnRow mt10">
    <button id="driveStatusBtn">Check Drive Status</button>
    <button id="driveSnapshotBtn" class="btnSpacer">Snapshot DB to Drive</button>
    <button id="driveBackupsBtn" class="btnSpacer">List Drive Backups</button>
  </div>

  <div class="muted small mt10" id="driveStatusLine"></div>
  <div id="driveBackupsBox"></div>
</div>

<div class="card mt14">
  <h3>DB Backup (Render Free Tier)</h3>
  <div class="muted">
    Render free tier has no persistent disk. Use <strong>Export</strong> to download a JSON backup and keep it safe.
    Use <strong>Import</strong> to restore the database after a redeploy/reset.
  </div>
  <div class="muted small mt10">
    Note: Google Drive snapshot/list/restore endpoints require Drive env vars to be configured on the server.
  </div>

  <div class="rowBackup mt10">
    <button id="exportDbBtn">Export DB to JSON</button>

    <div class="importBox">
      <label for="importFile">Import backup file</label>
      <input id="importFile" type="file" accept="application/json" />
      <button id="importDbBtn" class="btnSpacer">Import JSON Backup</button>
    </div>
  </div>

  <div class="muted small mt10" id="backupStatus"></div>
</div>

<div class="row">
  <div class="card">
    <h3>Recent Estimates</h3>
    <div class="muted">Latest stored quotes (for ops review).</div>
    <div id="quotesBox"></div>
  </div>

  <div class="card">
    <h3>Booking Requests</h3>
    <div class="muted">Approve → creates a job entry. Reject → closes the request.</div>
    <div id="requestsBox"></div>
  </div>
</div>

<div class="card mt14">
  <h3>Jobs</h3>
  <div class="muted">Jobs created after admin approval (baseline total uses cash quote; payment method set later).</div>
  <div id="jobsBox"></div>
</div>

<script>
  const statusLine = document.getElementById("statusLine");
  const backupStatus = document.getElementById("backupStatus");
  const driveStatusLine = document.getElementById("driveStatusLine");
  const driveBackupsBox = document.getElementById("driveBackupsBox");

  function authHeaders() {
    const u = (document.getElementById("adminUsername").value || "").trim();
    const p = (document.getElementById("adminPassword").value || "").trim();
    if (!u || !p) return {};
    return { "Authorization": "Basic " + btoa(u + ":" + p) };
  }

  async function fetchJSON(path) {
    const headers = authHeaders();
    const res = await fetch(path, { headers });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(JSON.stringify(data));
    return data;
  }

  function renderQuotes(items) {
    const box = document.getElementById("quotesBox");
    if (!items || items.length === 0) {
      box.innerHTML = "<div class='muted'>No quotes yet.</div>";
      return;
    }

    let rows = "";
    for (const q of items) {
      rows += "<tr>"
        + "<td><code>" + (q.quote_id || "") + "</code></td>"
        + "<td>" + (q.created_at || "") + "</td>"
        + "<td><span class='pill'>" + (q.job_type || "") + "</span></td>"
        + "<td>$" + Number(q.total_cad || 0).toFixed(2) + "</td>"
        + "</tr>";
    }

    box.innerHTML =
      "<table>"
      + "<thead><tr><th>Quote ID</th><th>Created</th><th>Type</th><th>Total (cash)</th></tr></thead>"
      + "<tbody>" + rows + "</tbody>"
      + "</table>";
  }

  function statusLabel(status) {
    const map = {
      customer_accepted_pending_admin: "Customer accepted (pending admin)",
      customer_declined: "Customer declined",
      admin_approved: "Admin approved",
      rejected: "Rejected"
    };
    return map[status] || (status || "unknown");
  }

  function requestActionsHtml(r) {
    const st = (r.status || "").toLowerCase();
    if (st === "customer_declined" || st === "rejected") {
      return "<span class='muted small'>No action needed</span>";
    }
    return "<button onclick=\"window.__approve('" + (r.request_id || "") + "')\">Approve</button>"
      + "<button onclick=\"window.__reject('" + (r.request_id || "") + "')\" class=\"btnSpacer\">Reject</button>";
  }

  async function decide(requestId, action) {
    const notes = prompt("Admin notes (" + action + ") - optional:") || "";
    statusLine.textContent = "Saving decision...";

    const headers = Object.assign({ "Content-Type": "application/json" }, authHeaders());

    const res = await fetch("/admin/api/quote-requests/" + encodeURIComponent(requestId) + "/decision", {
      method: "POST",
      headers,
      body: JSON.stringify({ action: action, notes: (notes.trim() || null) })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      statusLine.innerHTML = "<span class='bad'>Error:</span> " + JSON.stringify(data);
      return;
    }

    const jobId = data && data.job && data.job.job_id ? data.job.job_id : null;
    if (jobId) {
      statusLine.innerHTML = "<span class='ok'>Approved.</span> Job created: <code>" + jobId + "</code>";
    } else {
      statusLine.innerHTML = "<span class='ok'>Saved:</span> " + action.toUpperCase() + " for " + requestId;
    }

    await refreshAll();
  }

  function renderRequests(items) {
    const box = document.getElementById("requestsBox");
    if (!items || items.length === 0) {
      box.innerHTML = "<div class='muted'>No booking requests yet.</div>";
      return;
    }

    let rows = "";
    for (const r of items) {
      rows += "<tr>"
        + "<td><code>" + (r.request_id || "") + "</code><div class='small'>" + (r.created_at || "") + "</div></td>"
        + "<td><div><strong>" + (r.customer_name || "") + "</strong></div><div class='small'>" + (r.customer_phone || "") + "</div></td>"
        + "<td class='small'><div>" + (r.job_address || "") + "</div><div><span class='pill'>" + (r.service_type || "") + "</span></div></td>"
        + "<td class='small'><div><strong>Date:</strong> " + (r.requested_job_date || "-") + "</div><div><strong>Window:</strong> " + (r.requested_time_window || "-") + "</div></td>"
        + "<td>"
        + "<div class='small'><strong>Status:</strong> <span class='pill'>" + statusLabel(r.status) + "</span></div>"
        + "<div class='small'><strong>Cash:</strong> $" + Number(r.cash_total_cad || 0).toFixed(2) + "</div>"
        + "<div class='small'><strong>EMT:</strong> $" + Number(r.emt_total_cad || 0).toFixed(2) + "</div>"
        + "</td>"
        + "<td>" + requestActionsHtml(r) + "</td>"
        + "</tr>";
    }

    box.innerHTML =
      "<table>"
      + "<thead><tr><th>Request</th><th>Customer</th><th>Job</th><th>Requested</th><th>Totals</th><th>Actions</th></tr></thead>"
      + "<tbody>" + rows + "</tbody>"
      + "</table>";
  }

  function renderJobs(items) {
    const box = document.getElementById("jobsBox");
    if (!items || items.length === 0) {
      box.innerHTML = "<div class='muted'>No jobs yet.</div>";
      return;
    }

    let rows = "";
    for (const j of items) {
      rows += "<tr>"
        + "<td><code>" + (j.job_id || "") + "</code><div class='small'>" + (j.created_at || "") + "</div></td>"
        + "<td><code>" + (j.quote_id || "") + "</code></td>"
        + "<td><span class='pill'>" + (j.status || "") + "</span></td>"
        + "<td><div><strong>" + (j.customer_name || "") + "</strong></div><div class='small'>" + (j.customer_phone || "") + "</div></td>"
        + "<td class='small'>" + (j.job_address || "") + "</td>"
        + "<td>$" + Number(j.total_cad || 0).toFixed(2) + "</td>"
        + "<td class='small'>" + (j.notes || "") + "</td>"
        + "</tr>";
    }

    box.innerHTML =
      "<table>"
      + "<thead><tr><th>Job</th><th>Quote</th><th>Status</th><th>Customer</th><th>Address</th><th>Total</th><th>Notes</th></tr></thead>"
      + "<tbody>" + rows + "</tbody>"
      + "</table>";
  }

  function renderDriveBackups(items) {
    if (!items || items.length === 0) {
      driveBackupsBox.innerHTML = "<div class='muted'>No Drive backups found.</div>";
      return;
    }

    let rows = "";
    for (const f of items) {
      const link = f.web_view_link
        ? "<a href='" + f.web_view_link + "' target='_blank' rel='noopener noreferrer'>Open</a>"
        : "-";
      rows += "<tr>"
        + "<td><code>" + (f.name || "") + "</code></td>"
        + "<td>" + (f.created_time || "") + "</td>"
        + "<td>" + (f.size || "-") + "</td>"
        + "<td>" + link + "</td>"
        + "</tr>";
    }

    driveBackupsBox.innerHTML =
      "<table>"
      + "<thead><tr><th>Name</th><th>Created</th><th>Size (bytes)</th><th>Link</th></tr></thead>"
      + "<tbody>" + rows + "</tbody>"
      + "</table>";
  }

  async function refreshAll() {
    try {
      statusLine.textContent = "Loading...";

      const quotes = await fetchJSON("/admin/api/quotes");
      renderQuotes(quotes.items || []);

      const reqs = await fetchJSON("/admin/api/quote-requests");
      renderRequests(reqs.items || []);

      const jobs = await fetchJSON("/admin/api/jobs");
      renderJobs(jobs.items || []);

      statusLine.innerHTML = "<span class='ok'>Loaded.</span>";
    } catch (err) {
      statusLine.innerHTML = "<span class='bad'>Admin API error:</span> " + String(err);
    }
  }

  async function checkDriveStatus() {
    try {
      driveStatusLine.textContent = "Checking Drive...";
      const data = await fetchJSON("/health");
      const configured = data && data.drive_configured;
      driveStatusLine.innerHTML = configured
        ? "<span class='ok'>Drive configured.</span>"
        : "<span class='bad'>Drive not configured.</span>";
    } catch (err) {
      driveStatusLine.innerHTML = "<span class='bad'>Drive status check failed:</span> " + String(err);
    }
  }

  async function snapshotDrive() {
    try {
      driveStatusLine.textContent = "Creating Drive snapshot...";
      const headers = authHeaders();
      const res = await fetch("/admin/api/drive/snapshot", { method: "POST", headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(JSON.stringify(data));
      const name = data.name || data.file_id || "backup";
      driveStatusLine.innerHTML = "<span class='ok'>Snapshot complete:</span> <code>" + name + "</code>";
      await listDriveBackups();
    } catch (err) {
      driveStatusLine.innerHTML = "<span class='bad'>Snapshot failed:</span> " + String(err);
    }
  }

  async function listDriveBackups() {
    try {
      driveStatusLine.textContent = "Loading Drive backups...";
      const data = await fetchJSON("/admin/api/drive/backups?limit=20");
      renderDriveBackups(data.items || []);
      driveStatusLine.innerHTML = "<span class='ok'>Loaded Drive backups.</span>";
    } catch (err) {
      driveBackupsBox.innerHTML = "";
      driveStatusLine.innerHTML = "<span class='bad'>Could not list Drive backups:</span> " + String(err);
    }
  }

  async function exportDb() {
    try {
      backupStatus.textContent = "Exporting...";
      const headers = authHeaders();
      const res = await fetch("/admin/api/db/export", { headers });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(JSON.stringify(data));
      }

      const blob = await res.blob();
      const dispo = res.headers.get("Content-Disposition") || "";
      let filename = "bay_delivery_backup.json";
      const m = dispo.match(/filename="([^"]+)"/i);
      if (m && m[1]) filename = m[1];

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      backupStatus.innerHTML = "<span class='ok'>Exported.</span> Saved as <code>" + filename + "</code>";
    } catch (err) {
      backupStatus.innerHTML = "<span class='bad'>Export failed:</span> " + String(err);
    }
  }

  async function importDb() {
    try {
      const file = document.getElementById("importFile").files[0];
      if (!file) {
        backupStatus.innerHTML = "<span class='bad'>Choose a JSON file first.</span>";
        return;
      }

      if (!confirm("This will WIPE the current DB and restore from the JSON backup. Continue?")) {
        return;
      }

      backupStatus.textContent = "Importing...";

      const text = await file.text();
      const payload = JSON.parse(text);

      const headers = Object.assign({ "Content-Type": "application/json" }, authHeaders());
      const res = await fetch("/admin/api/db/import", {
        method: "POST",
        headers,
        body: JSON.stringify({ payload })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(JSON.stringify(data));

      const restored = data.restored || {};
      backupStatus.innerHTML =
        "<span class='ok'>Imported.</span> " +
        "quotes=" + (restored.quotes || 0) + ", " +
        "quote_requests=" + (restored.quote_requests || 0) + ", " +
        "jobs=" + (restored.jobs || 0);

      await refreshAll();
    } catch (err) {
      backupStatus.innerHTML = "<span class='bad'>Import failed:</span> " + String(err);
    }
  }

  window.__approve = (id) => decide(id, "approve");
  window.__reject = (id) => decide(id, "reject");

  document.getElementById("driveStatusBtn").addEventListener("click", checkDriveStatus);
  document.getElementById("driveSnapshotBtn").addEventListener("click", snapshotDrive);
  document.getElementById("driveBackupsBtn").addEventListener("click", listDriveBackups);
  document.getElementById("exportDbBtn").addEventListener("click", exportDb);
  document.getElementById("importDbBtn").addEventListener("click", importDb);
  document.getElementById("refreshBtn").addEventListener("click", refreshAll);
</script>

</body>
</html>
