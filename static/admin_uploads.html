<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bay Delivery — Admin Uploads</title>
  <link rel="stylesheet" href="/static/admin.css" />
  <link rel="stylesheet" href="/static/admin_uploads.css" />
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="brandMark">BD</div>
        <div class="brandTitle">
          <strong>Bay Delivery</strong><br />
          <span class="muted">Admin — Uploads</span>
        </div>
      </div>
      <div class="toplinks">
        <a class="badgeLink" href="/admin">Dashboard</a>
        <a class="badgeLink" href="/">Home</a>
      </div>
    </div>

    <div class="card">
      <h1>Customer Uploads</h1>
      <p class="muted">Search by Quote ID to see photos stored in Google Drive.</p>

      <div class="formWrap">
        <label for="quote_id">Quote ID</label>
        <input id="quote_id" placeholder="paste quote id here" />
        <div class="btnRowTop">
          <button class="btn" id="btnSearch" type="button">Search</button>
        </div>
      </div>
    </div>

    <div class="card resultsHidden" id="resultsCard">
      <h2>Results</h2>
      <div id="results"></div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);

  function bootstrapTokenFromUrl() {
    const url = new URL(window.location.href);
    const token = (url.searchParams.get("token") || "").trim();
    if (!token) return;
    sessionStorage.setItem("bay_admin_token", token);
    url.searchParams.delete("token");
    window.history.replaceState({}, "", url.toString());
  }

  function authHeaders() {
    const token = (sessionStorage.getItem("bay_admin_token") || "").trim();
    if (token) return { "X-Admin-Token": token };
    return {};
  }

  function showResults(items) {
    const card = el("resultsCard");
    const out = el("results");
    card.classList.remove("resultsHidden");
    out.innerHTML = "";

    if (!items || items.length === 0) {
      out.textContent = "No uploads found for that quote_id.";
      return;
    }

    for (const it of items) {
      const div = document.createElement("div");
      div.className = "resultRow";

      const name = document.createElement("div");
      const strong = document.createElement("strong");
      strong.textContent = it.filename || "file";
      const mime = document.createElement("span");
      mime.className = "muted";
      mime.textContent = " (" + (it.mime_type || "") + ")";
      name.append(strong, mime);

      const link = document.createElement("a");
      link.href = it.drive_web_view_link || "#";
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = it.drive_web_view_link ? "Open in Drive" : "No link";

      const meta = document.createElement("div");
      meta.className = "muted";
      meta.textContent = "Uploaded: " + (it.created_at || "") + " • Size: " + (it.size_bytes || 0) + " bytes";

      div.appendChild(name);
      div.appendChild(link);
      div.appendChild(meta);
      out.appendChild(div);
    }
  }

  el("btnSearch").addEventListener("click", async () => {
    const q = (el("quote_id").value || "").trim();
    if (!q) return;

    const res = await fetch("/admin/api/uploads?quote_id=" + encodeURIComponent(q), {
      headers: authHeaders()
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        el("resultsCard").classList.remove("resultsHidden");
        el("results").textContent = "Unauthorized — open /admin or /admin/uploads with ?token=... once, or authenticate in your browser.";
        return;
      }
      throw new Error(JSON.stringify(data));
    }
    showResults(data.items || []);
  });

  bootstrapTokenFromUrl();
</script>
</body>
</html>
